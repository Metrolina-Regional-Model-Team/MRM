---
title: "Time of Day"
output:
  html_document:
    theme: cosmo
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
      number_sections: false
    toc_depth: 4
    css: "styles.css"
---

For each tour, the Metrolina model predicts the choice of forward and return time periods with the choices being Peak (PK) or Off-peak (OP). Therefore, every tour falls under one of four categories depending on the forward and return period, namely PK_PK, PK_OP, OP_PK, OP_OP. The previous version of the model reverts to a trip-based approach after destination choice. PK and OP matrices were generated by purpose on which the mode choice models were evaluated. A TOD model then subsequently splits the PK and OP mode choice output matrices by using PA/AP factors to generate subperiod (AM, MD, PM and NT) matrices. 

The updated Metrolina model deviates slightly from this approach. Like in the previous model, the forward and return period (PK/OP) is predicted for each tour. However, the mode choice is also tour-based, and the time-of-day model is applied just before the creation of the OD matrices. Therefore, there is a need to generate 4 sets of matrices (AM, MD, PM and NT) from the tour level output. 

This is done by analyzing the survey to apportion the appropriate combination of PK_PK, PK_OP, OP_PK and OP_OP tours into sub-periods. 
For example, the PK_PK combination has three possibilities (AM_AM, AM_PM and PM_PM). The survey was used to obtain percentages of tours in each subcategory by purpose. These are directly applied in the model. 

The tables containing these factors are shown below. 

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(dplyr)
```

### Peak to Peak factors 
```{r,echo=FALSE, warning=FALSE, message=FALSE}

abs_data <- data.frame(
  PK_PK = c("AM_AM", "AM_PM", "PM_PM", "Total"),
  Work = c(21450, 245819, 5490, 272759),
  School = c(43915, 117975, 3523, 165413),
  University = c(1073, 11933, 139, 13145),
  Shop = c(12444, 14554, 47762, 74759),
  Other = c(162307, 103305, 144099, 409711),
  AtWork = c(4376, 919, 3304, 8599),
  stringsAsFactors = FALSE
)


abs_data_formatted <- abs_data %>%
  mutate(across(where(is.numeric), ~ format(., big.mark = ",", scientific = FALSE)))

perc_data <- data.frame(
  PK_PK = c("AM_AM", "AM_PM", "PM_PM"),
  Work = c("7.9%", "90.1%", "2.0%"),
  School = c("26.5%", "71.3%", "2.1%"),
  University = c("8.2%", "90.8%", "1.1%"),
  Shop = c("16.6%", "19.5%", "63.9%"),
  Other = c("39.6%", "25.2%", "35.2%"),
  AtWork = c("50.9%", "10.7%", "38.4%"),
  stringsAsFactors = FALSE
)

empty_row <- data.frame(PK_PK = "", Work = "", School = "", University = "",
                        Shop = "", Other = "", AtWork = "",
                        stringsAsFactors = FALSE)

combined_data <- rbind(abs_data_formatted, empty_row, perc_data)

table_model <- kable(combined_data, 
                     col.names = c("", "Work", "School", "University", "Shop", "Other", "AtWork"),
                     align = c("l", "r", "r", "r", "r", "r", "r"),
                     escape = FALSE) %>% 
  kable_styling(bootstrap_options = c("bordered", "striped"),
                full_width = TRUE,
                font_size = 14) %>%
  add_header_above(c(" " = 1, "Tour Distribution" = 6)) %>%
  pack_rows("Percentage Distribution", 6, nrow(combined_data))

table_model
```

### Peak to Off-Peak factors 
```{r,echo=FALSE, warning=FALSE, message=FALSE}

abs_data <- data.frame(
  PK_OP = c("AM_MD", "AM_NT", "PM_NT", "Total"),
  Work = c(50499, 99474, 19378, 169350),
  School = c(58609, 13508, 4182, 76299),
  University = c(10349, 5368, 4959, 20675),
  Shop = c(43509, 13297, 52959, 109765),
  Other = c(135633, 39825, 193032, 368490),
  AtWork = c(2785, 36, 564, 3386),
  stringsAsFactors = FALSE
)

abs_data_formatted <- abs_data %>%
  mutate(across(where(is.numeric), ~ format(., big.mark = ",", scientific = FALSE)))

perc_data <- data.frame(
  PK_OP = c("AM_MD", "AM_NT", "PM_NT"),
  Work = c("29.8%", "58.7%", "11.4%"),
  School = c("76.58%", "17.7%", "5.5%"),
  University = c("50.1%", "26.0%", "24.0%"),
  Shop = c("39.6%", "12.1%", "48.2%"),
  Other = c("36.8%", "10.8%", "52.4%"),
  AtWork = c("82.3%", "1.1%", "16.7%"),
  stringsAsFactors = FALSE
)

empty_row <- data.frame(PK_OP = "", Work = "", School = "", University = "",
                        Shop = "", Other = "", AtWork = "",
                        stringsAsFactors = FALSE)

combined_data <- rbind(abs_data_formatted, empty_row, perc_data)

table_model <- kable(combined_data, 
                     col.names = c("", "Work", "School", "University", "Shop", "Other", "AtWork"),
                     align = c("l", "r", "r", "r", "r", "r", "r"),
                     escape = FALSE) %>% 
  kable_styling(bootstrap_options = c("bordered", "striped"),
                full_width = TRUE,
                font_size = 14) %>%
  add_header_above(c(" " = 1, "Tour Distribution" = 6)) %>%
  pack_rows("Percentage Distribution", 6, nrow(combined_data))

table_model
```

### Off Peak to Peak factors 
```{r,echo=FALSE, warning=FALSE, message=FALSE}

abs_data <- data.frame(
  OP_PK = c("MD_PM", "NT_AM", "NT_PM", "Total"),
  Work = c(32206, 7567, 76713, 116486),
  School = c(3243, 1866, 13621, 18730),
  University = c(1002, 568, 133, 1703),
  Shop = c(62524, 2653, 5241, 70417),
  Other = c(155120, 15894, 28077, 199091),
  AtWork = c(5407, 72, 0, 5480),
  stringsAsFactors = FALSE
)

abs_data_formatted <- abs_data %>%
  mutate(across(where(is.numeric), ~ format(., big.mark = ",", scientific = FALSE)))

perc_data <- data.frame(
  OP_PK = c("MD_PM", "NT_AM", "NT_PM"),
  Work = c("27.6%", "6.5%", "65.9%"),
  School = c("17.3%", "10.0%", "72.7%"),
  University = c("58.8%", "33.3%", "7.8%"),
  Shop = c("88.8%", "3.8%", "7.4%"),
  Other = c("77.9%", "8.0%", "14.1%"),
  AtWork = c("98.7%", "1.3%", "0.0%"),
  stringsAsFactors = FALSE
)

empty_row <- data.frame(OP_PK = "", Work = "", School = "", University = "",
                        Shop = "", Other = "", AtWork = "",
                        stringsAsFactors = FALSE)

combined_data <- rbind(abs_data_formatted, empty_row, perc_data)

table_model <- kable(combined_data, 
                     col.names = c("", "Work", "School", "University", "Shop", "Other", "AtWork"),
                     align = c("l", "r", "r", "r", "r", "r", "r"),
                     escape = FALSE) %>% 
  kable_styling(bootstrap_options = c("bordered", "striped"),
                full_width = TRUE,
                font_size = 14) %>%
  add_header_above(c(" " = 1, "Tour Distribution" = 6)) %>%
  pack_rows("Percentage Distribution", 6, nrow(combined_data))

table_model

```

### Off Peak to Off Peak factors 
```{r,echo=FALSE, warning=FALSE, message=FALSE}

abs_data <- data.frame(
  OP_OP = c("MD_MD", "MD_NT", "NT_MD", "NT_NT", "Total"),
  Work = c(11955, 45843, 22337, 53916, 134052),
  School = c(6686, 788, 4046, 3380, 14900),
  University = c(2167, 2958, 425, 4681, 10232),
  Shop = c(156742, 17405, 751, 48629, 223527),
  Other = c(310301, 53755, 10608, 187114, 561779),
  AtWork = c(57697, 32, 34, 1950, 59714),
  stringsAsFactors = FALSE
)

abs_data_formatted <- abs_data %>%
  mutate(across(where(is.numeric), ~ format(., big.mark = ",", scientific = FALSE)))

perc_data <- data.frame(
  OP_OP = c("MD_MD", "MD_NT", "NT_MD", "NT_NT"),
  Work = c("8.9%", "34.2%", "16.7%","40.2%"),
  School = c("44.9%", "5.3%", "27.2%","22.7%"),
  University = c("21.2%", "28.9%", "4.2%","45.7%"),
  Shop = c("70.1%", "7.8%", "0.3%","21.8%"),
  Other = c("55.2%", "9.6%", "1.9%", "33.3%"),
  AtWork = c("96.6%", "0.1%", "0.1%", "3.3%"),
  stringsAsFactors = FALSE
)

empty_row <- data.frame(OP_OP = "", Work = "", School = "", University = "",
                        Shop = "", Other = "", AtWork = "",
                        stringsAsFactors = FALSE)

combined_data <- rbind(abs_data_formatted, empty_row, perc_data)

table_model <- kable(combined_data, 
                     col.names = c("", "Work", "School", "University", "Shop", "Other", "AtWork"),
                     align = c("l", "r", "r", "r", "r", "r", "r"),
                     escape = FALSE) %>% 
  kable_styling(bootstrap_options = c("bordered", "striped"),
                full_width = TRUE,
                font_size = 14) %>%
  add_header_above(c(" " = 1, "Tour Distribution" = 6)) %>%
  pack_rows("Percentage Distribution", 6, nrow(combined_data))

table_model

```