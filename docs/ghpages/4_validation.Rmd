---
title: "Validation"
output:
  html_document:
    theme: cosmo
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
      number_sections: false
    toc_depth: 4
    css: "styles.css"
---

In addition to the calibration checks performed for each submodel, where model performance is compared back to the survey used to estimate it, the final results are also compared to independent data sources not used in estimation. This is the validation set. Caliper used traffic counts and observed transit ridership to validate that the estimated models did a good job predicting conditions in 2022 (the base year). 

The table below shows the model link volumes compared to traffic counts by volume group. Percent difference and percent root mean square error (%RMSE) all look great. While the percent difference for the 100000+ category looks low, there are only 2 counts and low volume. This means that even small differences look larger in percentage terms. 

### Model Comparison
```{r,echo=FALSE, warning=FALSE, message=FALSE}

library(kableExtra)
library(scales)
library(dplyr)

# Create the data frame
data <- data.frame(
  VolumeGroup = c("1,0000", "25,000", "50,000", "100,000", "100,000+", "All"),
  N = c(2063, 1161, 469, 146, 2, 3841),
  TotalCount = c(9051500, 18626300, 16041100, 9764300, 205200, 53688400),
  TotalVolume = c(9284533, 17149797, 15547126, 9637426, 176706.3, 51795589),
  PctDiff = c(2.57, -7.93, -3.08, -1.3, -13.89, -3.53),
  PRMSE = c(56.19, 29.98, 22.54, 14.66, 13.89, 33)
)

data <- data %>%
  mutate(
    N = comma(N),
    TotalCount = comma(TotalCount),
    TotalVolume = comma(TotalVolume),
    PctDiff = format(PctDiff, nsmall = 2), 
    PRMSE = format(PRMSE, nsmall = 2)
  )


# Generate the table
table_model <- kable(data, 
                     col.names = c("Volume Group", "N", "Total Count", "Total Volume", "Percent Difference", "PRMSE"),
                     align = c("l", "r", "r", "r", "r", "r")) %>%
  kable_styling(bootstrap_options = c("bordered", "striped"),
                full_width = TRUE,
                font_size = 14)

# Print the table
table_model

```

In the next table, link volumes are compared to counts by facility type. The model is predicting lower volumes on facility type C than observed. Given the strong performance by volume group, Caliper did not deem this a problem, but future enhancements could look into this facility type. 

```{r,echo=FALSE, warning=FALSE, message=FALSE}

# Create the data frame
data <- data.frame(
  FacType = c("Divided - left turn bays", "Undivided - continuous left", "Divided - no median breaks", "Expressway", "Freeway", "Divided - median breaks only", "Ramp", "Undivided - left turn bays", "Undivided - no left provision", "All"),
  N = c(304, 304, 48, 19, 306, 49, 2, 271, 2538, 3841),
  TotalCount = c(8081500, 5428200, 1215100, 486800, 14786100, 997800, 36800, 5251800, 17404300, 53688400),
  TotalVolume = c(8160430, 4477111, 1144579, 426668.5, 14728504, 996694.7, 32253.92, 5289483, 16539864, 51795589),
  PctDiff = c(0.98, -17.52, -5.8, -12.35, -0.39, -0.11, -12.35, 0.72, -4.97, -3.53),
  PRMSE = c(26.83, 34.93, 28.38, 20.15, 15.81, 25.55, 12.38, 28.63, 44.74, 33)
)

# Format numeric columns with commas
data <- data %>%
  mutate(
    N = comma(N),
    TotalCount = comma(TotalCount),
    TotalVolume = comma(TotalVolume),
    PctDiff = format(PctDiff, nsmall = 2),
    PRMSE = format(PRMSE, nsmall = 2)
  )

# Generate the table
table_model <- kable(data, 
                     col.names = c("Facility Type", "N", "Total Count", "Total Volume", "Percent Difference", "PRMSE"),
                     align = c("l", "r", "r", "r", "r", "r")) %>%
    kable_styling(bootstrap_options = c("bordered", "striped"),
                full_width = TRUE,
                font_size = 14)


# Print the table
table_model
```

In addition to these summary-level validation checks, Caliper also checked for link level differences using the maps shown below. 

* Blue links: the model is lower than counts 
* Red links: the model is higher than counts 
* Green links: the model is close to counts 

```{r, echo=FALSE, out.width="65%", fig.align="center"}
knitr::include_graphics("Images/RegNetAM.png")
```

The table below shows observed unlinked transit boardings compared to the model. The model is matching the observed data well. 

```{r,echo=FALSE, warning=FALSE, message=FALSE}
data <- data.frame(
  Mode = c("Bus", "Rail"),
  Observed = c(28000, 16000),
  Model = c(30000, 16000)
)

# Format numeric columns with commas
data <- data %>%
  mutate(
    Observed = comma(Observed),
    Model = comma(Model)
  )

# Generate the table
table_model <- kable(data, 
                     col.names = c("Mode", "Observed", "Model"),
                     align = c("l", "r", "r")) %>%
    kable_styling(bootstrap_options = c("bordered", "striped"),
                full_width = TRUE,
                font_size = 14)


# Print the table
table_model
```
